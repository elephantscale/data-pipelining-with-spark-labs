<p><link rel='stylesheet' href='../assets/css/main.css'/></p>
<h1 id="spark-sql">Spark SQL</h1>
<h2 id="objective">Objective</h2>
<p>Spark supports SQL as a query language. Spark also has one of the sophisticated SQL optimizing engines around.</p>
<p>In this module you will learn about using Spark SQL</p>
<h2 id="what-you-will-learn">What you will learn</h2>
<ul>
<li>Understand Spark SQL architecture</li>
<li>Spark SQL features</li>
<li>SQL optimization engine</li>
<li>Writing Spark SQL queries</li>
<li>Learn the new Adaptive Query Optimizer in Spark 3</li>
</ul>
<h2 id="knowledge-check">Knowledge Check</h2>
<p><strong>What are the advantages of SQL over Scala or Python API?</strong></p>
<p><strong>How do we create a ‘table view’ of a dataframe for SQL query?</strong></p>
<p><strong>What is the scope of created table views?</strong></p>
<h2 id="essential-reading">Essential Reading</h2>
<h3 id="spark-sql-1">Spark SQL</h3>
<ul>
<li><a href="https://learning.oreilly.com/library/view/learning-spark-2nd/9781492050032/ch04.html">Ch 4 - Spark SQL and DataFrames: Introduction to Built-in Data Sources</a> from book <a href="https://learning.oreilly.com/library/view/learning-spark-2nd/9781492050032/">Learning Spark - 2nd Edition</a></li>
</ul>
<h2 id="extra-reading">Extra Reading</h2>
<h3 id="adaptive-query-execution-aqe">Adaptive Query Execution (AQE)</h3>
<p>This is a new SQL engine introduced in Spark v3</p>
<ul>
<li><a href="https://www.youtube.com/watch?v=OLJKIogf2nU&amp;feature=youtu.be">AQE explained</a> - Watch from mark 20:00 minute mark to 23:00 minute mark</li>
<li><a href="https://databricks.com/blog/2020/05/29/adaptive-query-execution-speeding-up-spark-sql-at-runtime.html">Adaptive Query Engine</a></li>
<li><a href="https://sparkbyexamples.com/spark/spark-adaptive-query-execution/">Some sample code on using AQE</a></li>
</ul>
<h2 id="labs">Labs</h2>
<h3 id="lab-1-spark-sql-with-small-data">Lab-1 : Spark SQL with small data</h3>
<ul>
<li>We will start with small dataset.</li>
<li>Follow this notebook <a href="sql-1-query-small-data.ipynb">sql-1-query-small-data.ipynb</a> ( <a href="sql-1-query-small-data.html">html version</a>)</li>
</ul>
<h3 id="lab-2-load-visa-data-and-query">Lab-2: Load VISA data and query</h3>
<ul>
<li>In this lab, we will try SQL queries with large amount of data</li>
<li>You can use pre-generated data or the data you generated in previous lab</li>
<li>Lab file : <a href="sql-2-query-large-data.py">sql-2-query-large-data.py</a></li>
</ul>
<p>A few things to experiment:</p>
<ul>
<li>Load data in both CSV and parquet format. And measure the query speed. Do you see a noticeable difference?</li>
<li>Enable ‘adaptive query optimizer (AQE)’ and run your queries. Do you see any noticeable difference?</li>
<li>Use <code>explain</code> command to see what optimizations are applied to Spark SQL queries.</li>
</ul>
<h2 id="review-and-key-takeaways">Review and Key Takeaways</h2>
<p>After completing this chapter:</p>
<ul>
<li>You should be able to answer the ‘Knowledge Check’ questions comfortably (see start of the document)</li>
<li>Load csv and parquet dataframes with schema and register them as tables</li>
<li>Be able to query data using SQL</li>
</ul>
